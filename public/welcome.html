<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width,initial-scale=1">
	<title>Welcome You</title>
	<link rel="stylesheet" href="css/bootstrap.min.css">
	<link rel="stylesheet" type="text/css" href="css/my-login.css">
	<link rel="stylesheet" href="css/main.css">
</head>

<body onload="load()">
	<div class="container">
		<div class="center">
			<div class="textarea">
				<table cellpadding="0" cellspacing="0" border="0" width="100%">
					<tr valign="top" width="100%">
						<td width="35%" class="sidebar">
							<div class="sidebarheading">
								<div id="username">
									请先进行登录认证
								</div>
							</div>
							<div class="sidebaritems">
								<form name="frmInput">
									<div style="padding-top:10px">
										<textarea rows=16 style="width:100%;" class="sidebartextarea form-control"
											name="txtPlaintext" placeholder="在此输入发送的数据" maxlength="50"></textarea>
										<div align="right">
											<input type="button" value="发送" class="btn btn-primary" name="encrypt"
												style="margin-top: 10px;" onclick="encryptClick()">
										</div>
									</div>
								</form>
								<form name="frmSender" method="post">
									<input type="hidden" name="ciphertext">
								</form>
							</div>
						</td>
					</tr>
				</table>
			</div>
		</div>
	</div>

	<script src="./lib/jquery-3.3.1.slim.min.js"></script>
	<script src="./lib/bootstrap.min.js"></script>
	<script src="./lib/js.cookie.min.js"></script>
	<script src="js/my-login.js"></script>
	<script src="js/BigInt.js"></script>
	<script src="js/Barrett.js"></script>
	<script src="js/stripped.js"></script>
</body>

<script>
	const user = JSON.parse(Cookies.get("user") ?? null);
	if (!user) {
		alert("请先进行登录认证");
		window.location.href = '/index.html';
	} else {
		$("#username")[0].innerHTML = `欢迎您， ${user.user}`;
	}
</script>

<style>
	.container {
		position: relative;
		height: 100%;
	}

	.center {
		position: absolute;
		top: 50%;
		left: 50%;
		transform: translate(-50%, -50%);
	}
</style>

<script>
	let key = "";
	function load() {
		setMaxDigits(262);
		key = new KeyPair(
			"10001",
			"",
			"C5FA3DC3DE71C5E58FBA5BB5063241D165C20205B02584E7BBF91B81D21263CC235D2725105B8C40FC1ADD30C2BC93AD766990AC1D1F76866AB1D7CD01B51F2B4F8D0AB30B8E12ED72A756D8D043F82F011723F8C35D8D7C8F71F92A68AF15690A28E03A1A27A7D2F968A3DEBC78DA1138CEFCA9D4CC2C8002A4A4B7B3CB96CF73F6754FA359FE1ACB11AFA052F597E6D5AEDFAEB13853EBFA493A125EF176CF1960CDF8502BB9E41E7973BE3DC2C5493F9F94E1D8AAF55030CCA5824F7C3A581C51CA816347A5EA442CE319BF990072A499CDDBCE86326CA4806A2FC79F765E3045ED977C4924EA23DFB9D90FC3672F4BBCD6E509EC50ED7E74D65B575F6F2F",
			2048
		);
	}

	async function encryptClick() {
		const ciphertext = encryptedString(key, document.frmInput.txtPlaintext.value);
		const cipherBase = window.btoa(ciphertext);

		const data = { uuid: Cookies.get('uuid'), username: JSON.parse(Cookies.get("user")).user, cipherBase };
		const response = await fetch('/user/decrypt', {
			method: 'POST',
			headers: {
				'Content-Type': 'application/json;charset=utf-8'
			},
			body: JSON.stringify(data)
		});

		if (response.ok) {
			const json = await response.json();

			if (json.code === 200) {
				alert(json.msg);
			} else {
				alert(json.error);
			}
		} else {
			alert("发送失败");
		}
	}
</script>

</html>